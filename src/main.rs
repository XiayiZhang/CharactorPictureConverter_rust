use std::env;
use image::{DynamicImage, GenericImageView, GrayImage};
use std::path::Path;
use native_dialog::FileDialog;
use chrono::Local;

fn main() {
    //println!("[debug]wd: {:?}", std::env::current_dir().unwrap());
    println!("CharactorArtConverter\nAuthor:XiayiZhang\nhttps://github.com/XiayiZhang\nhttps://xiayizhang.github.io");
    println!("Selecting file...");
    let args: Vec<String> = env::args().collect();
//    println!("input image route：");
//
//    let mut file = String::new();
//    stdin()
//        .read_line(&mut file)
//        .expect("读取失败！");
    let input_path = match FileDialog::new()
        .set_location("~")
        .add_filter("JPEG Image", &["jpg", "jpeg"])
        .show_open_single_file()
    {
        Ok(Some(path)) => path,
        Ok(None) => {
            println!("Cancelled choosing");
            return;
        }
        Err(e) => {
            eprintln!("Wrong dialogue: {}", e);
            return;
        }
    };
    //let input_path = "image.jpg";
    let time = Local::now().format("%Y-%m-%d_%H-%M-%S").to_string();
    let output_path = time+".txt";

    let img = match image::open(&Path::new(&input_path)) {
        Ok(img) => img,
        Err(e) => {
            eprintln!("Cannot load image because: {}", e);
            return;
        }
    };

    let gray_img = img.to_luma8();

    let chars = ['█','▓', '▒', '$', '░', '*', '.', ' '];

    let ascii_art = convert_to_ascii(&gray_img, &chars);
    println!("[character picture start]\n{}\n[character picture stop]",&ascii_art);
    if let Err(e) = std::fs::write(&output_path, ascii_art) {
        eprintln!("Cannot save file: {}", e);
    } else {
        println!("CharacterPicture saved to {}", output_path);
    }
}

fn convert_to_ascii(img: &GrayImage, chars: &[char]) -> String {
    let (width, height) = img.dimensions();
    
    let adjusted_height = height / 2;

    let mut result = String::new();
    let char_count = chars.len() as u8;

    for y in 0..adjusted_height {
        for x in 0..width {
            // 采样时，将 y 坐标映射回原图高度
            let pixel = img.get_pixel(x, y * 2);
            let luminance = pixel[0];

            let index = (luminance as f32 / 255.0 * (char_count - 1) as f32).round() as usize;
            let index = index.min(chars.len() - 1);
            result.push(chars[index]);
        }
        result.push('\n');
    }
    result
}
/*

                                                                                           .*$$$░░...*.░$                   
      ▒██▓████▓$$░..                                                                   *▓█▓▒░******░▒░░*▓$                  
     *▓***░$********░$▒▓██$.                                                       .▒█▓░**********$░░░░*░█.                 
     ▒▒**░░░░$▒░************$▓█▒░.                  ...░░░░░░░░░░░...           .▒█$. ...********$░░░░░░*▓$                 
     ▒▒**░░░░░░░$$***************$▓█▒.      ░▒▓██▓▒$░░**************░$▒▓██▓░░.$█▒. ...*  .******$░░░░░░░*░█                 
     ▒▒**░░░░░░░░░░▒*****************░▓███▒░**********************************░$▒░*   ..  *****$░░░░░░░░**█░                
     ▒▒**░░░░░░░░░░░░▒********************░$****************************************░▒$*. ****░░░░░░░░░░░*▒▒                
     *▓**░░░░░░░░░░░░░$$****************************************************.. ..********$$***▒░░░░░░░░░░*$▒                
     *▓**░░░░░░░░░░░░░░░▒*************************░$░***********************.......**░░░****$$*▒░░░░░░░░░*░█.               
     *█***░░░░░░░░░░░░░░░░$*********************$****************...***...**.......*******$****▒░░░░░░░░░**█.               
      █░**░░░░░░░░░░░░░░░░░▒******************░░*****************************.....**********$****▒$░░░░░░**▓░               
      █$**░░░░░░░░░░░░░░░░░░$****************$************************************************$****▒░░░░░**▓$               
      ░▓**░░░░░░░░░░░░░░░░$$$***************$***************************************************░***░▒░░░**▓$               
      *█***░░░░░░░░░░░░░░░░░***************░*******************░*********************░***********$****▒░░**▒$               
      .█░**░░░░░░░░░░░░░░*****************░********************░░*********************▒***********░░***$$**▒$               
       ▒▒**░░░░░░░░░░░░░***************************************░░*********************▒▓*********░░*$***░$*▒$               
       ░▓***░░░░░░░░░░**************************░**************░$*********************░▓$*********░$░▒$$**$▓$               
       *█░**░░░░░░░░*******░*******************░***************░▒*******************░**▒*▒░*******░$*......▒▒  *█░          
        ▓▒***░░░░░░********░*******************$***************░▒*******************░**▒**░▒******$░.... ...▓$▓██.          
        ░▓****░░░░********$************.░░****▒░***************░▓░******************░░*░░****$▒***░░... ....▒░$█.           
         █░***░░░*********$*************$░***░▓****************$█$******************░░$▒▒░********░$$░....░▒*▒█             
         ▒▒**************$░*************░░***▒▒*░*************░▓$▒***░*************░░░**▒*.        .*$▓▒▓▒░░*▓$             
         *█**************▒*************░░░**$$$░░*************░$*▒***░*************░░░░*▒*           .$░$▒░░*$█             
         ▒▓$*************$*.***********$░░*░▒░$░░*************$**▒***░░***********░░░$░*▒*            .▒░░$░**█.            
         █░$************░░*************$░░░$░$$░░************░$**▒**░░░***********░░░▒░░▒.         .*░▒▓▒▒▓░**▓░            
         ▓**************$**************$░░░▒*$░░░░***********▒***▒░░░$$**********░░░$▒░░$.    .$▓█████▓▓▓▓▓$**▒▓            
        ░▒**************▒*************░$░░$░*$░░░░**********░░*.*$░░░$░░*******░*░░░▒▒░$*  *▓█▓▓▓▓▓▒▒▓▒.. ░$**$▓            
        ░$**************▒*************$░░░▒***░░░░**********$*. .$░░░▒░░*******░░░░░▒$░$  ▒██▓▒▒▒▒▒▒▒▒▓*..*$**░█.           
        ░░**************$*************$░░░**░$▒▓▓▓▓▓▓▓▓▓▒$░$*.   $░░$▒░░******░░░$$▒$$$*  *.▓▒▒▒▒* .$$$$. .▒***█.           
        ▓░**************░*************$░▒▒▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓░  ░░$░▒░*******░░$***...    .▒$$░░░.*░░░$...$***█░           
        ▓**************░░*************$░░░*....░▓▒▒▒▒▒▒▒▒▒▒▒$.*.  .. .        .            .$░░░░░░░░*░$.  $***▓$           
       *▓**************░**************$........▓▒▒▒▒▒▒▒▒$..$▒░                              $****░$****░   ░***▓▒           
       *▒**************░**************$. ...  .▒$░░░░░░░░..*░▒.                             ░**********░   *░**▒▒           
       *▒**************░**************░.       $░░░░░░░░░░░░░▒*                             .$**......░     $**▒▒           
       *▒**************$**************░*       ░░******░$****$*                               ░*....*░     ..$*▒▒           
       *▒**************$***************$       .$*******░****$.                                 .*░*   ......*$▒▒           
       *▒**************$*************░*$.       *░*****...****                                       .........*▓▒           
       *▒**************$*************░**░        .░**.......░                      .                ...........$▒           
       *▓**************$*************░$*$.         .░*...*░.            ..░$$$$░░░░░░░░$$$*.        ...........░█           
       *▓**************$**************░$*$*.........                .░$░░░░░░░░░░░░░░░░░░░░░$*.      ..........░█           
       *$**************$**************░░▒$$............            .$░░░░░░***********░░░░░░░░$.      .........$▓           
       ░▓**************░░**************░▒░$▒░...........       .$░$$░*********************░░░░░░.       ......*▓.           
      ░░▓░*************░░**************░$*...*...........     ░░░**************************░░░░$.            *$▓$           
     ░* ▓░*************░$**************░$*..............    .$░******************************░░$.          .░░*▓.           
   **   ░$*************░$***************$*.............     $░*******************************░░░          *$***▓.           
 ..     ░▒*************░▒***************$*...........      .$********************************░$.        *$****░▓*           
         ▓*************░▒***************░*......           .░********************************$.      .░$░░*****▒$           
         ▓*************░$░**************░░.                .$******************************..     .*▒░░░░░*****░$           
         ▓************░░░▒***░***********$**.               .*░***********************....     .░▒░░▒░░░░░*****▒░           
   *░░.$░$$********░**░░░▒***░***********$****..                ....**********......      .*$▒$░░░░░▒░░░░░*****▒▒░.         
  .$▒▒░*$$▒********░**░░░$$***░░*********▒▒$░****....                               ..░▒▒▒$░░░░░░░░░▒░░░░░*****$▒ ░░.       
  .░▒    *▒********░**░░░░▒***░░*********░▒▒▒▒▒▒▒▒▒▒▒$$$$░░*******........**░░$▒▒▓▒▒$$$$$$░░░░░░░░░░$$░░░░*****$▒   *░░░    
   $$.   *▓********░*░░░░░$$**░░**********▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒**************$▓$$$$$$$$$$$$$$$░░░$░░░░░░$$░░░******$▒           
  ░*▒ ▒░$░▓********░░░░░░░$▓**░░░*********$▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒**************▒▒$$▒$$$$$$$$$$▒$░░░$░░░░░░$$$░░*░****▒▒           
  ░░$ ▓░▒░▓********░░░░░░░░$▒**░░**********▓▒▒▒▒▒▒▒▒▒▒▒▒░*****************▒▒$$$$$$$$$$$$▒$░░$$$░░░░░▒▓$░░*░****▒▒           
  .*▓░  .*▓****░***░░░░░░░░$▒$*░░░*********$▒▒▒▓▓▓▓▓▓▓▓▓$********************░▒▒▒$$$$$$$▒$░░$$$$░░░▒▒$$░░░░****▓$           
▒▒*░$.   *▓.*░*░***░░░░░░░░$$▒$░░░░*********▒▒▒▒▒▒▒▒▒▓▓▓▓▓▓$******************...░▒$$$$$▒▒$$$$$$$░░░░$$░*░*****█.           
.. ░$$.. $▒**$░░░**░░░░░░░$$$$▒$░░$░*********▒▓▓▒▒▒▒▒▒▒▒▓▓▓▓▓▓░*********....       .▓▓▒$▒▓$$$$$$$░░░░$$░░░****░▓.           
     $$.▒▓$**▓░░░**░░░░░░░$$$$$▒$░░$░*********▓▓▓▓▓▒▒▒▒▒▒▒▒▓▓▓▓▓▓▒░*.           .░▒▓▓▓▓▒▒█▒$$$$$$$░░░▒░░░**.**▓▒            
      ▒$*█**░█$░░░**░░░░░░$$$$$$▒▒░░▒░*********▒▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒$$$▓▒█▓$$$$$$$░░░▒░░░***.░█.            
      ▒$░▓**▓█▓░░░░*░░░░░░░$$$$$$$▒▒░▒░░********$▓▓▓▓▓▓▓▓▓▒▒▒$$$$$▒▒▓▓▓▓▓▓▓▓▓▒▒$$$$$$$$$▓██▓$$$$$$░░▒░░░****$█*             

                                                         @@@@@                              
  @@@@@@        @@@@                                     @@@@@                              
  @@@@@@@       @@@@                                     @@@@@                              
  @@@@@@@@      @@@@        @@@@@@            @@@@@@     @@@@@  @@@@@           @@@@@@      
  @@@@@@@@@     @@@@    @@@@@@@@@@@@@      @@@@@@@@@@@@  @@@@@@@@@@@@@@      @@@@@@@@@@@@   
  @@@@  @@@@@   @@@@     @@      @@@@@   @@@@@@    @@@   @@@@@@    @@@@@   @@@@@@    @@@@@  
  @@@@   @@@@@  @@@@             @@@@@   @@@@            @@@@@      @@@@   @@@@        @@@@ 
  @@@@    @@@@  @@@@      @@@@@@@@@@@@  @@@@             @@@@@      @@@@   @@@@        @@@@@
  @@@@     @@@@@@@@@    @@@@@    @@@@@  @@@@@            @@@@@      @@@@   @@@@        @@@@ 
  @@@@       @@@@@@@   @@@@      @@@@@   @@@@@           @@@@@      @@@@   @@@@@      @@@@@ 
  @@@@       @@@@@@@    @@@@   @@@@@@@   @@@@@@@   @@@   @@@@@      @@@@    @@@@@@  @@@@@@  
  @@@@         @@@@@    @@@@@@@@@ @@@@     @@@@@@@@@@@   @@@@@      @@@@      @@@@@@@@@@    
                                                                                            
                                                                                            
                                         @@@@                                               
  @@@@@@        @@@@                     @@@@                                               
  @@@@@@@       @@@@                     @@@@                                               
  @@@@@@@@      @@@@         @@@@@       @@@@                 @@@@@                         
  @@@@@@@@@     @@@@     @@@@@@@@@@@@    @@@@    @@@@@@    @@@@@@@@@@@@                     
  @@@@  @@@@@   @@@@    @@@@@    @@@@@   @@@@   @@@@@    @@@@@     @@@@@                    
  @@@@   @@@@@  @@@@   @@@@@       @@@   @@@@ @@@@@      @@@@       @@@@@                   
  @@@@    @@@@  @@@@   @@@@@@@@@@@@@@@   @@@@@@@@@@     @@@@         @@@@                   
  @@@@     @@@@@@@@@   @@@@              @@@@@@@@@@@    @@@@@        @@@@                   
  @@@@       @@@@@@@    @@@@             @@@@@   @@@@@   @@@@@      @@@@@                   
  @@@@       @@@@@@@    @@@@@@    @@@    @@@@     @@@@@  @@@@@@   @@@@@@                    
  @@@@         @@@@@      @@@@@@@@@@@    @@@@      @@@@@    @@@@@@@@@@                      
                                                                                            
                                                                                            

*/
